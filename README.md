# 🌼NodeJS (ver 14)

📚 가물가물해진 노드 웹서버를 이해하기 위해 다시 한 번 학습중인 나만의 NodeJS 참고서

<br>

## 🌸 공부목차

📋 노드의 핵심 개념인 런타임, 이벤트 기반, 논블로킹, 싱글 스레드 모델을 확실히 이해하기<br>
📋 내장 객체와 내장 모듈을 사용해보면서 기능들을 이해하기<br>
📋 데이터베이스 (MySQL / 몽고디비 ) <br>
📋 패키지 매니저인 npm<br>
📋 웹 서버 프레임워크인 익스프레스<br>
📋 템플릿 엔진인 퍼그와 넌적스 등 노드 생태계를 배우며 실제로 동작하는 서버만들기<br><br>

## 🌸 노드설치

노드 공식 사이트에 접속 후 최신 버전을 설치한다.

```
$node -v // 노드 버전 확인
$npm -n // 노드 패키지 매니저를 사용해야 하므로 이것도 제대로 설치됐는지 확인
$npm install -g npm // npm 버전 업데이트하기
```

## 🌸 Node란 ?

> Node.js는 크롬 V8 자바스크립트 엔진으로 빌드된 자바스크립트 런타임이다.

<br>

## 🌸 서버

노드를 통해 다양한 자바스크립트 애플리케이션을 실행할 수 있지만, 노드는 <b>서버 애플리케이션</b>을 실행하는 데 가장 많이 사용된다.

서버란, 네트워크를 통해 클라이언트에 정보나 서비스를 제공하는 컴퓨터 또는 프로그램을 말한다. 여기서 클라이언트란 요청을 보내는 주체로 브라우저 일수도, 데스크톱 프로그램일 수도, 모바일 앱일수도 있고 다른 서버에 요청을 보내는 서버일 수도 있다.

```
클라이언트 <--------(요청/응답)---------> 서버
```

> 예제1번 ➡ 주소창에 네이버의 웹사이트 주소를 입력(요청)하면 브라우저는 그 주소에 해당하는 네이버의 컴퓨터 위치를 파악한다. 그리고 그 컴퓨터로부터 네이버 웹 사이트 페이지를 받아와 요청자의 브라우저(클라이언트)에 띄운다(응답)

> 예제2번 ➡ 모바일 앱의 경우이다. 구글 플레이 스토어나 애플 앱스토어에서 원하는 앱을 고른 후 설치 버튼을 누르면(요청) 내려받기(응답)가 시작된다. 그럼 앱 설치 파일은 이미 어딘가에 저장되어 있으므로 우리가 그곳에 데이터를 받아와 모바일 기기에 설치할 수 있는 것이다. 플레이스토어와 앱스토어는 클라이언트 역할을 해주는 것이다.

이렇게 웹이나 앱을 사용할 때 우리의 데이터(아이디, 비밀번호, 이메일)와 서비스의 데이터가 생성된다. 이 데이터를 어딘가에 저장하고, 그 어딘가에서 클라이언트로 데이터를 받아와야 한다. 이곳이 바로 <b>서버</b>이다.

<br>

## 🌸 이벤트 기반

이벤트 기반이란 이벤트가 발생할 때 <b>미리 지정해둔 작업을 수행하는 방식</b>을 의미한다. 이벤트로는 클릭이나 네트워크 요청이 있을 수 있다.
이벤트 기반 시스템에서는 특정 이벤트가 발생할 때 무엇을 할지 미리 등록해둬야 한다.
이를 <b>이벤트 리스터에 콜백 함수를 등록 한다</b> 라고 표현한다.

이벤트 기반 모델에서는 <b>이벤트 루프</b>라는 개념이 등장한다. 여러 이벤트가 동시 발생했을 때 어떤 순서로 콜백 함수가 호출할지를 이벤트 루프가 판단한다.

```
function first() {
  second();
  console.log('첫번째);
}
function second() {
  third();
  console.log('두번째);
}
function third() {
  console.log('세번째);
}
first( );
```

> 결과값 : 세번째, 두번째, 첫번째<br>first 함수가 제 일 먼저 호출되고, 그 안의 second 함수가 호출된 뒤, 마지막으로 third 함수가 호출된다. 실행은 호출된 순서와 반대로 실행이 완료된다. 따라서 콘솔에는 세 번째, 두 번째, 첫 번째, 순서로 찍히게 된다.

<br><br>

```
function run() {
  console.log('3초 후 실행);
}
consoloe.log('시작');
setTimeout(run, 3000);
console.log('끝');
```

> 결과값 : 시작, 끝, 3초 후 실행 <br>
> 3초 뒤에 run 함수를 실행하는 코드이다. 콘솔 결과는 쉽게 예측할 수 있어도 호출 스택으로 설명하기는 힘들다. setTimeout 함수의 콜백인 run이 호출 스택에 언제 들어가는지 파악하려면 <b>이벤트 루프, 태스크 큐, 백그라운드</b>를 알아야 한다.

<br>

- 이벤트루프 : 이벤트 발생 시 호출할 콜백 함수들을 관리하고, 호출된 콜백 함수의 실행 순서를 결정하는 역할을 담당한다. 노드가 종료될 때까지 이벤트 처리를 위한 작업을 반복하므로 <b>루프</b>라고 부른다.

- 백그라운드 : setTimeout 같은 타이머나 이벤트 리스너들이 대기하는 곳입니다. 자바스크립트가 아닌 다른 언어로 작성된 프로그램이라고 봐도 됩니다. 여러 작업이 동시에 실행될 수 있다.

- 태스크 큐(콜백큐) : 이벤트 발생 후, 백그라운드에서 태스크 큐로 타이머나 이벤트 리스너의 콜백 함수를 보낸다. 정해진 순서대로 콜백들이 줄을 서 있으므로 콜백 큐라고도 부른다. 콜백들은 보통 완료된 순서대로 줄을 서 있지만 특정한 경우에는 순서가 바뀌기도 한다.

<br>

## 🌸 논 블로킹 I/O

> 이벤트 루프를 잘 활용하면 오래 걸리는 작업을 효율적으로 처리할 수 잇다. 작어벵는 두 가지 종류가 있는데, 동시에 실행될 수 있는 작업과 없는 작업이 있다.
> 우리가 작업한 자바스크립트 코드는 동시에 실행될 수 없다. 하지만 자바스크립트상에서 돌아가는 것이 아닌 I/O 작업 같은 것은 동시에 처리 될 수 있다.
>
> > I/O는 입력(INPUT)과 출력(OUTPUT)을 의미한다. 파일 시스템 접근(파일 읽기, 파일 쓰기, 폴더 만들기 등)이나 네트워크를 통한 요청같은 작업이 I/O의 일종이다. 이러한 작업을 할 때 <B>노드는 논블로킹 방식으로 처리하는 방법을 제공</B>한다.

- 논블로킹이란 ? 이전 작업이 완료될 때 까지 대기하지 않고 다음 작업을 수행함.
- 블로킹이란? 이전 작업이 끝나야만 다음 작업을 수행할 수 있다.

<b>🟠 정리</b> : 노드는 논블로킹 방식으로 처리하는 방법을 제공한다는데, 그래서 블로킹 방식보다 더 짧은 시간에 처리할 수 있음을 알 수 있다. (다만 작업들이 모두 동시처리 될 수 있다는 작업이란 전제하)

작업 순서에 따라 성능이 크게 달라진다. 동시에 처리 될 수 있는 I/O 작업이라도 논 블로킹 방식으로 코딩하지 않으면 의미가 퇴색되므로 <B>논 블로킹 방식</B>으로 코딩하는 습관들 들여야한다.

<br>

- 블로킹 방식의 코드입니다.

```
function lognRunningTask() {
  //오래 걸리는 작업
  console.log('작업끝');
}

console.log('시작');
lognRunningTask();
console.log('다음 작업');
```

> 결과 : 시작, 작업 끝, 다음 작업

작업을 수행하는 데 오래 걸리는 lognRunningTask 함수가 있고, 이 함수가 블로킹 방식의 I/O 작업을 한다고 생각해본다면 이 작업이 완료되기 전까지는 이어지는 console.log('다음 작업')이 호출되지 않는다.

<br>

- 논 블로킹 방식의 코드입니다.

```
function longRunningTask() {
  //오래 걸리는 작업
  console.log('작업끝');
}

console.log('시작');
setTimeout(longRunningTake, 0);
console.log('다음 작업');
```

> 결과값 : 시작, 다음 작업, 작업 끝

여기서 <b>setTimeout(콜백, 0)은 코드를 논 블로킹으로 만들기 위해 사용하는 기법 중 하나</b>이다. 사실 노드에는 setTimeout(콜백, 0) 대신 다른 방식을 주로 사용하긴 한다. 이벤트 루프를 이해했다면 setTimeout의 콜백 함수인 longRunningTake가 태스크 큐로 보내지므로 순서대로 실행되지 않는다는 것을 알 수 있다.

다만, 아무리 논 블로킹 방식으로 코드를 작성하더라도 전체 소요 시간이 짧아지지는 않는다. 왜냐면 이 코드는 서로 동시에 실행되지 않기 때문이다. 단순히 실행 순서만 바뀔 뿐이다.

그렇다고 I/O 작업이 없다고 해서 논 블로킹이 의미가 없는 것은 아니다. 오래 걸리는 작업을 처리해야 하는 경우, 논 블로킹을 통해 실행 순서를 바꿔줌으로써 그 작업 때문에 간단한 작업들이 대기하는 상황을 막을 수 잇다는 점에서 의의가 있다. 또한, 논블로킹과 동시가 같은 의미가 아니라는 것도 알아둬야 한다.

<br>

### 🟠 <b>그냥 알아 둘 것 !</b>

setTimeout(콜백, 0) 여기서 밀리초를 0으로 설정했으므로 바로 실행되는 것으로 착각 할 수 있는데, HTML5 브라우저에서는 4ms, 노드에서는 1ms의 지연 시간이 있다.

### 🟠 <b>총정리</b> : 노드에서는 <b>동기와 블로킹이 유사</b>하고, <b>비동기와 논블로킹이 유사</b>하다고만 알아두면 된다.

<br>

## 🌸 싱글 스레드

> 스레드가 하나뿐이라는 것을 의미한다. 스레드를 이해하기 위해서는 프로세스부터 알아야 된다.

- 프로세스 : 운영체제에서 할당하는 작업의 단위이다. 노드나 웹 브라우저 같은 프로그램은 개별적인 프로세스이다.
- 스레드 : 프로세스 내에서 실행되는 흐름의 단위이다. 프로세스는 스레드를 여러 개 생성해 여러 작업을 동시에 처리할 수 있다. 스레드들은 부모 프로세스의 자원을 공유한다.

### 🟠 노드는 싱글스레드다 ?!

> 노드는 싱글 스레드라는 말들이 많은데 엄밀히 말하자면 싱글 스레드로 동작하지는 않는다. 노드를 실행하면 먼저 프로세스가 하나 생성된다. 그리고 그 프로세스에서 스레드를 생성하는데, 이때 내부적으로 스레드를 여러 개 생성한다. 그중에서 직접 제어할 수 있는 스레드는 하나뿐이다. 그래서 흔히 <b>노드가 싱글 스레드</b>라고 여겨지는 것이다.

요청이 많이 들어오면 한 번에 하나씩 요청을 처리한다. 블로킹이 심하게 일어나는 작업을 처리하지만 않는다면 스레드 하나로도 충분하다. 블로킹이 발생할 것 같은 경우에는 논블로킹 방법으로 대기 시간을 최대한 줄인다.

### 🟠 <b>그냥 알아 둘 것 !</b>

> 노드가 싱글 스레드로 동작하지 않는 두 가지 경우가 있다.

1. 스레드풀 : 노드가 특정 동작을 수행할 때 스스로 멀티 스레드를 사용한다.
2. 워커 스레드 : 노드 12버전에서 안정화된 기능으로 이제 노드에서도 멀티 스레드를 사용할 수 있게 되었다. 우리가 직접 다수의 스레드를 다룰 수 있다. CPU 작업이 많은 경우 워커 스레드를 사용하면 된다.

여기서 멀티스레드는 언뜻 보면 여러 개 일을 동시 처리 할 수 있어보여 멀티 스레드가 싱글 스레드보다 좋아보이는데 꼭 그렇지만은 않다.

- 예시1 : 음식점에 점원 1명, 손님 여러명이 있다. 점원 한 명이 주문을 받아 주방에 넘기고 주방에서 요리가 나오면 손님에게 서빙을 한다. 그 후 다음 손님의 주문을 받는다 이런 구조라면 다음 손님은 이전 손님의 요리가 나올 때 가지 아무것도 못하고 기다려야 되는데 이걸 바로 (싱글 스레드-점원)과 블로킹 모델을 비유한 것이다. 💢매우 비효율적임💢

- 예시2 : 점원이 한 손님의 주문을 받고 주방에 주문 내역을 넘긴 뒤 다음 손님의 주문을 받는다. 요리가 끝나기까지 기다리는 대신, 주문이 들어왔다는 사실만 주방에 계속 알려주는 것이다. 주방에서 요리가 완료되면 완료된 순서대로 손님에게 서빙한다. 요리의 특성(블로킹인지 논블로킹인지)에 따라 완료되는 순서가 다를 수 있으므로, 주문이 들어온 순서와 서빙하는 순서는 일치하지 않을 수도 있다. 이것이 바로 싱글 스레드, 논블로킹 모델을 비유한 것이다. 💢 노드가 채택하고 있는 방식 💢<br>
  이렇게 점원은 한명이지만 혼자서 많은 일을 처리할 수 있다. 하지만 그 점원이 아파서 쓰러지거나 하면 큰 문제가 생길 수 있다. 또한 요리를 하는 데 시간이 오래 걸린다면 (CPU를 많이 쓰는 작업) 주문이 많이 들어왔을 떄 버거울 수 있다.

- 예시3 : 멀티 스레드 방식에서는 손님 한 명이 올 때마다 점원도 한 명씩 붙어 주문을 받고 서빙을 한다. 언뜻 보면 싱글 스레드 보다 좋은 방법 인 것 같지만, 장단점이 있다.
  손님의 수가 늘어날 수록 점원의 수도 늘어난다. 손님 수가 줄었을 떄 일을 하지 않고 노는 점원이 있다는 것도 문제가 된다. 점원을 새로 고용하거나 기존 점원을 해고하는 데는 비용이 발생한다. 그렇다면 점원 여러명(멀티 스레드)이 모두 논 블로킹 방식으로 주문을 받으면 더 좋지 않을까 하는 의문이 들 수도 있다. 실제로 그렇다. 다만 멀티 스레드 방식으로 프로그래밍하는 것은 상당히 어려우므로 💢멀티 프로세싱 방식을 대신 사용한다. <B>I/O 요청에는 멀티 프로세싱이 더 효율적</B>이기도 하다.💢

  <br>

---

<br>

| 멀티 스레딩                                  |       멀티프로세싱       |
| -------------------------------------------- | :----------------------: |
| 하나의 프로세스 안에서 여러 개의 스레드 사용 |  여러개의프로세스 사용   |
| cpu 작업이 많을 떄 사용                      |  I/O요청이 많을 때 사용  |
| 프래그래밍이 어려워짐                        | 프로그래밍이 비교적 쉬움 |

> I/O 작업을 처리할 때는 멀티 스레딩보다 멀티 프로세싱이 효율적이므로 노드는 멀티 프로세싱을 많이한다. 그 방법은 다른 섹션폴더에서 차차 공부해 나가는걸로,,

<br>

## 🌸 서버로서의 노드

> 노드를 서버로 사용할 때의 특성과 장단점을 알아보자.

- 장점 : 서버에는 기본적으로 I/O 요청이 많이 발생하므로, I/O 처리를 잘하는 노드를 서버로 사용하면 좋다. 노드는 libuv 라이브러리를 사용하여 I/O 작업을 논 블로킹 방식으로 처리한다. 따라서 스레드 하나가 많은 수의 I/O를 혼자서도 감당할 수 있다.

- 단점 : 노드는 CPU 부하가 큰 작업에는 적합하지 않다. 우리가 작성하는 코드는 모두 스레드 하나에서 처리된다. 코드가 CPU 연산을 많이 요구하면 스레드 하나가 혼자서 감당하기 어렵다.

### 🟠 이같은 특성을 활용하려면 노드는 어디서 사용해야 되는가 ?

> 개수는 많지만 크기는 작은 데이터를 실시간으로 주고받는 데 적합하다.

- 네트워크나 데이터베이스, 디스크 작업 같은 I/P에 특화되어 있다.
- 실시간 채팅 어플리케이션, 주식 차트, JSON 데이터 등등에 API 서버가 노드를 많이 사용한다.

노드 12 버전에서 워커 스레드 기능의 안정화로 멀티 스레드 작업을 할 수 있게 되었지만, 멀티 스레드 프로그래밍을 하는 것은 싱글 스레드 비해 어렵다. 특히 스레드가 작업을 나눠서 처리할 수 있게 직접 나누어주는 것이 그렇다. 또한, 멀티 스레드 프로그래밍을 하더라도 C, C++,Rust, GO와 같은 언어에 비해 속도가 현저히 느리다.

따라서 멀티 스레드 기능이 있다고 하더라도 이미지나 비디오 처리, 혹은 대규모 데이터 처리처럼 CPU를 많이 사용하는 작업을 위한 서버로는 권장하지 않는다. 노드보다 더 적합한 다른 언어 서버를 이용하길 바람.

🙌 싱글 스레드 방식의 프로그래밍은 멀티 스레드 방식보다 상대적 쉬우므로 서버 프로그래밍에 익숙하지 않는 사람도 쉽게 입문할 수 있다. 다만 싱글 스레드 방식으로 서버를 운영할 때는 하나뿐인 스레드가 에러로 인해 멈추지 않도록 잘 관리해야 한다. 에러를 제대로 처리하지 못하면 하나뿐인 스레드가 죽어버려서 서버 전체가 멈춘다.

🙌 노드 장점중에 하나가 노드에는 웹 서버가 내장되어 있어서 좋다. 노드 외 서버를 개발하다보면 아파치, nginx, IIS처럼 별도의 웹 서버를 설치해야 하는 경우가 많다. 심지어 톰캣 같은 웹 애플리케이션 서버를 추가로 설치해야 하는 경우도 있는데 이 경우에는 프로그래밍 외에도 웹 서버와 WAS 사용법을 익혀야 한다.
<B>하지만 노드는 내장된 웹 서버를 사용하면 되므로 편리하다.</B> 하지만 나중에 서버 규모가 커지면 결국 nginx등의 웹 서버를 노드 서버와 연결해야만 한다는 점 !!!

🙌 데이터를 주고 받을 떄는 XML 대신 JSON을 사용해서 데이터를 주고받는데, JSON이 자바스크립트 형식이므로 노드에서는 쉽게 처리할 수 있다.

<BR>

## 🌸노드 장단점 한눈에 보기

<br>

| 장점                                          | 단점                                              |
| --------------------------------------------- | ------------------------------------------------- |
| 멀티 스레드 방식에 비해 적은 컴퓨터 자원 사용 | 기본적으로 싱글 스레드라서 CPU 코어를 하나만 사용 |
| I/O 작업이 많은 서버로 적합                   | CPU 작업이 많은 서버로는 부적합                   |
| 멀티 스레드 방식보다 쉽다                     | 하나뿐인 스레드가 멈추지 않도록 관리가 필요하다   |
| 웹 서버가 내장되어있다.                       | 서버 규모가 커졌을 때 서버 관리하기가 어렵다      |
| 자바스크립트를 사용한다                       | 어중간한 성능                                     |
| JSON 형식과 쉽게 호환된다                     |                                                   |

<br>

## 🌸노드를 사용한 곳

웹 사이트 중에는 쇼핑몰, 블로그 같은 사이트도 많다. 이러한 사이트들은 정적인 콘텐츠를 많이 제공한다. 안정성과 보안성 측면 문제도 이미 충분히 검증되어있어서, 규모가 큰 곳을 꼽아 노드를 사용한 곳을 예를 들자면

- 미국항공유주국
- 에어비앤비
- 우버
- 넷플리스
- 링크드인
- 페이팔 (결제시스템)
- 월마트 (결제시스템)
- 이베이 (결제시스템)
- 네이버
- 카카오
- 위메프
- 야놀자

같은 기업에서 노드를 사용한다.
이렇게 노드는 사용 범위가 점점 늘어나 웹, 모바일, 데스크톱 애플리케이션 개발에도 사용되기 시작했고 노드 기반으로 돌아가는 대표적인 웹 프레임워크로는 <b>앵귤러, 💢리액트💢, 뷰</b> 등이 있다. 리액트는 페이스북 진영에서 주로 사용하고 모바일 개발 도구로는 리액트 네이티브를 많이 사용하고 있다.

- 페이스북
- 인스타그램
- 핀터레스트
- 월마트
- 테슬라

등이 리액트 네이티브를 사용하여 모바일 앱을 운영중이다.
